<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#080810">
<title>IdeaFlow</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Instrument+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #080810;
  --bg2: #0f0f1a;
  --surface: #14141f;
  --surface2: #1c1c2e;
  --surface3: #22223a;
  --border: rgba(255,255,255,0.06);
  --border2: rgba(255,255,255,0.1);
  --gold: #f5c842;
  --gold2: #e8a820;
  --red: #ff5c5c;
  --teal: #3fcfb4;
  --blue: #5b9cf6;
  --purple: #a78bfa;
  --text: #eeeef5;
  --text2: #9999b5;
  --text3: #55556a;
  --r: 14px;
  --r2: 20px;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

html { scroll-behavior: smooth; }

body {
  font-family: 'Instrument Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  min-height: 100dvh;
  overscroll-behavior: none;
}

/* Noise texture overlay */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  opacity: 0.025;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 9999;
}

/* â”€â”€ LAYOUT â”€â”€ */
.app {
  max-width: 680px;
  margin: 0 auto;
  padding: 0 16px 140px;
}

/* â”€â”€ HEADER â”€â”€ */
header {
  padding: 52px 0 28px;
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
  gap: 16px;
}

.logo-wrap h1 {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 52px;
  letter-spacing: 2px;
  line-height: 1;
  color: var(--text);
}
.logo-wrap h1 span { color: var(--gold); }
.logo-wrap p {
  font-size: 13px;
  color: var(--text2);
  margin-top: 4px;
  letter-spacing: 0.2px;
}

.api-btn {
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: 10px;
  padding: 8px 14px;
  color: var(--text2);
  font-family: 'Instrument Sans', sans-serif;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 6px;
}
.api-btn:hover { border-color: var(--gold); color: var(--gold); }
.api-btn.connected { color: var(--teal); border-color: rgba(63,207,180,0.3); background: rgba(63,207,180,0.06); }

/* â”€â”€ STATS BAR â”€â”€ */
.stats-bar {
  display: flex;
  gap: 10px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}
.stat {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 16px;
  flex: 1;
  min-width: 80px;
  text-align: center;
}
.stat-n {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 28px;
  letter-spacing: 1px;
  color: var(--gold);
  line-height: 1;
}
.stat-l {
  font-size: 11px;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-top: 3px;
}

/* â”€â”€ INPUT CARD â”€â”€ */
.input-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r2);
  padding: 18px;
  margin-bottom: 20px;
  transition: border-color 0.25s;
}
.input-card:focus-within { border-color: rgba(245,200,66,0.25); }

.input-top {
  display: flex;
  gap: 10px;
  margin-bottom: 12px;
  flex-wrap: wrap;
}

select, .text-input {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 14px;
  color: var(--text);
  font-family: 'Instrument Sans', sans-serif;
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s;
  -webkit-appearance: none;
}
select:focus, .text-input:focus { border-color: rgba(245,200,66,0.4); }
select { cursor: pointer; flex: 1; min-width: 140px; }
select option { background: #1c1c2e; }
.text-input { flex: 1; min-width: 140px; }
.text-input::placeholder { color: var(--text3); }

textarea {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 14px;
  color: var(--text);
  font-family: 'Instrument Sans', sans-serif;
  font-size: 15px;
  line-height: 1.6;
  resize: none;
  min-height: 90px;
  outline: none;
  transition: border-color 0.2s;
  display: block;
}
textarea:focus { border-color: rgba(245,200,66,0.4); }
textarea::placeholder { color: var(--text3); }

/* voice recording indicator */
textarea.recording {
  border-color: rgba(255,92,92,0.5);
  background: rgba(255,92,92,0.04);
}

.btn-row {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  flex-wrap: wrap;
}

/* â”€â”€ BUTTONS â”€â”€ */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 11px 18px;
  border-radius: 10px;
  font-family: 'Instrument Sans', sans-serif;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  border: none;
  transition: all 0.18s;
  line-height: 1;
}
.btn:active { transform: scale(0.97); }

.btn-gold {
  background: var(--gold);
  color: #0a0a0a;
  flex: 1;
}
.btn-gold:hover { background: #f7d460; }

.btn-ghost {
  background: var(--surface2);
  color: var(--text2);
  border: 1px solid var(--border);
}
.btn-ghost:hover { border-color: var(--border2); color: var(--text); }

.btn-voice {
  background: var(--surface2);
  color: var(--text2);
  border: 1px solid var(--border);
  position: relative;
}
.btn-voice.recording {
  background: rgba(255,92,92,0.12);
  border-color: rgba(255,92,92,0.5);
  color: var(--red);
}
.btn-voice.recording::before {
  content: '';
  position: absolute;
  inset: -3px;
  border-radius: 13px;
  border: 2px solid rgba(255,92,92,0.4);
  animation: pulse-ring 1.2s ease-out infinite;
}
@keyframes pulse-ring {
  0% { opacity: 1; transform: scale(1); }
  100% { opacity: 0; transform: scale(1.15); }
}

.btn-teal {
  background: rgba(63,207,180,0.12);
  color: var(--teal);
  border: 1px solid rgba(63,207,180,0.25);
  flex: 1;
}
.btn-teal:hover { background: rgba(63,207,180,0.18); }

.btn-sm {
  padding: 6px 11px;
  font-size: 12px;
  border-radius: 8px;
}

.btn-icon {
  padding: 8px;
  border-radius: 8px;
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text2);
  cursor: pointer;
  transition: all 0.15s;
  display: inline-flex;
  align-items: center;
}
.btn-icon:hover { color: var(--text); border-color: var(--border2); }

/* â”€â”€ FILTER BAR â”€â”€ */
.section-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  color: var(--text3);
  margin-bottom: 10px;
  font-weight: 600;
}

.filter-bar {
  display: flex;
  gap: 6px;
  margin-bottom: 8px;
  flex-wrap: wrap;
  align-items: center;
}

.chip {
  padding: 6px 14px;
  border-radius: 99px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text2);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.15s;
  font-family: 'Instrument Sans', sans-serif;
  white-space: nowrap;
}
.chip:hover { border-color: var(--border2); color: var(--text); }
.chip.active {
  background: var(--gold);
  border-color: var(--gold);
  color: #0a0a0a;
  font-weight: 600;
}

/* â”€â”€ SORT BAR â”€â”€ */
.sort-row {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}
.sort-btn {
  font-size: 12px;
  color: var(--text3);
  background: none;
  border: none;
  cursor: pointer;
  font-family: 'Instrument Sans', sans-serif;
  padding: 4px 10px;
  border-radius: 6px;
  transition: all 0.15s;
  display: flex;
  align-items: center;
  gap: 3px;
}
.sort-btn:hover { color: var(--text2); background: var(--surface); }
.sort-btn.active { color: var(--gold); background: rgba(245,200,66,0.08); }
.sort-divider { width: 1px; height: 14px; background: var(--border); margin: 0 2px; }

/* â”€â”€ IDEA CARDS â”€â”€ */
.ideas-list { display: flex; flex-direction: column; gap: 10px; }

.topic-group { animation: fade-in 0.3s ease; }
@keyframes fade-in { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

.group-header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 14px 2px 8px;
  cursor: pointer;
  user-select: none;
}
.group-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.group-name {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 16px;
  letter-spacing: 2px;
  color: var(--text2);
  flex: 1;
}
.group-count {
  font-size: 11px;
  color: var(--text3);
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 99px;
  padding: 2px 8px;
}
.group-chevron {
  color: var(--text3);
  font-size: 11px;
  transition: transform 0.2s;
}
.group-chevron.closed { transform: rotate(-90deg); }

.idea-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 14px 16px 14px 20px;
  position: relative;
  overflow: hidden;
  transition: border-color 0.2s, transform 0.2s, box-shadow 0.2s;
  animation: card-in 0.25s ease;
}
@keyframes card-in {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}
.idea-card:hover {
  border-color: var(--border2);
  box-shadow: 0 4px 24px rgba(0,0,0,0.35);
  transform: translateY(-1px);
}
.pbar {
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 3px;
}

.card-top {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  margin-bottom: 10px;
}
.idea-body { flex: 1; }
.idea-text {
  font-size: 15px;
  line-height: 1.55;
  color: var(--text);
  word-break: break-word;
}
.idea-elaboration {
  font-size: 13px;
  line-height: 1.6;
  color: var(--text2);
  margin-top: 8px;
  padding: 10px 12px;
  background: var(--surface2);
  border-radius: 8px;
  border-left: 2px solid var(--teal);
  font-style: italic;
  display: none;
}
.idea-elaboration.visible { display: block; }
.idea-suggestions {
  font-size: 13px;
  color: var(--text2);
  margin-top: 8px;
  padding: 10px 12px;
  background: var(--surface2);
  border-radius: 8px;
  border-left: 2px solid var(--purple);
  display: none;
}
.idea-suggestions.visible { display: block; }
.idea-suggestions ul { padding-left: 16px; margin-top: 4px; }
.idea-suggestions li { margin-bottom: 3px; }

.pbadge {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  padding: 3px 9px;
  border-radius: 99px;
  flex-shrink: 0;
  white-space: nowrap;
}
.p5 { background: rgba(255,92,92,0.15);   color: #ff7070; border: 1px solid rgba(255,92,92,0.3); }
.p4 { background: rgba(255,160,50,0.15);  color: #ffaa44; border: 1px solid rgba(255,160,50,0.3); }
.p3 { background: rgba(245,200,66,0.15);  color: var(--gold); border: 1px solid rgba(245,200,66,0.3); }
.p2 { background: rgba(91,156,246,0.15);  color: var(--blue); border: 1px solid rgba(91,156,246,0.3); }
.p1 { background: rgba(100,100,130,0.12); color: var(--text3); border: 1px solid rgba(100,100,130,0.2); }

.card-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}
.meta-tag {
  font-size: 11px;
  color: var(--text3);
  display: flex;
  align-items: center;
  gap: 3px;
}
.card-actions {
  display: flex;
  gap: 5px;
  margin-left: auto;
  flex-wrap: wrap;
}

/* loading spinner in btn */
.spinner {
  width: 14px; height: 14px;
  border: 2px solid rgba(0,0,0,0.2);
  border-top-color: #000;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  display: inline-block;
}
@keyframes spin { to { transform: rotate(360deg); } }
.spinner-light {
  border: 2px solid rgba(255,255,255,0.15);
  border-top-color: var(--teal);
}

/* â”€â”€ EMPTY STATE â”€â”€ */
.empty {
  text-align: center;
  padding: 60px 20px;
  color: var(--text3);
}
.empty-icon { font-size: 48px; margin-bottom: 16px; }
.empty h3 { font-family: 'Bebas Neue', sans-serif; font-size: 24px; letter-spacing: 1px; color: var(--text2); margin-bottom: 8px; }
.empty p { font-size: 14px; line-height: 1.6; }

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(6px);
  z-index: 1000;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  padding: 16px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s;
}
.modal-overlay.open {
  opacity: 1;
  pointer-events: all;
}
.modal {
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-radius: 20px;
  padding: 24px;
  width: 100%;
  max-width: 480px;
  transform: translateY(20px);
  transition: transform 0.3s;
  max-height: 80vh;
  overflow-y: auto;
}
.modal-overlay.open .modal { transform: translateY(0); }
.modal h2 {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 26px;
  letter-spacing: 1.5px;
  margin-bottom: 6px;
}
.modal p { font-size: 14px; color: var(--text2); line-height: 1.6; margin-bottom: 16px; }
.modal input {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: 10px;
  padding: 12px 14px;
  color: var(--text);
  font-family: 'Instrument Sans', sans-serif;
  font-size: 15px;
  outline: none;
  margin-bottom: 12px;
}
.modal input:focus { border-color: rgba(245,200,66,0.5); }
.modal input::placeholder { color: var(--text3); }
.modal-row { display: flex; gap: 10px; }
.modal-step {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px 14px;
  margin-bottom: 8px;
  font-size: 13px;
  color: var(--text2);
  line-height: 1.6;
}
.modal-step strong { color: var(--gold); display: block; margin-bottom: 2px; }
a.modal-link {
  color: var(--gold);
  text-decoration: none;
  border-bottom: 1px solid rgba(245,200,66,0.3);
}

/* â”€â”€ TOAST â”€â”€ */
.toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(0);
  background: var(--surface3);
  border: 1px solid var(--border2);
  border-radius: 12px;
  padding: 12px 20px;
  font-size: 14px;
  color: var(--text);
  z-index: 2000;
  white-space: nowrap;
  pointer-events: none;
  transition: all 0.3s;
  opacity: 0;
  transform: translateX(-50%) translateY(10px);
}
.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}
.toast.success { border-color: rgba(63,207,180,0.4); }
.toast.error { border-color: rgba(255,92,92,0.4); }

/* â”€â”€ EXPORT MENU â”€â”€ */
.export-menu {
  position: fixed;
  bottom: 80px;
  right: 16px;
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-radius: 14px;
  padding: 8px;
  z-index: 500;
  display: none;
  flex-direction: column;
  gap: 4px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  min-width: 180px;
}
.export-menu.open { display: flex; animation: fade-up 0.2s ease; }
@keyframes fade-up {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
.export-item {
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 14px;
  color: var(--text2);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: all 0.15s;
  background: none;
  border: none;
  font-family: 'Instrument Sans', sans-serif;
  width: 100%;
  text-align: left;
}
.export-item:hover { background: var(--surface2); color: var(--text); }

/* â”€â”€ BOTTOM FAB â”€â”€ */
.fab-bar {
  position: fixed;
  bottom: 0;
  left: 0; right: 0;
  padding: 12px 16px max(16px, env(safe-area-inset-bottom));
  background: linear-gradient(to top, var(--bg) 60%, transparent);
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  z-index: 100;
}

/* scrollbar */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 99px; }

/* mobile tweaks */
@media (max-width: 480px) {
  header { padding-top: max(44px, env(safe-area-inset-top)); }
  .logo-wrap h1 { font-size: 42px; }
  .btn-row { gap: 6px; }
}
</style>
</head>
<body>

<div class="app">
  <!-- HEADER -->
  <header>
    <div class="logo-wrap">
      <h1>IDEA<span>FLOW</span></h1>
      <p>Deine Ideen. Organisiert. Ausgearbeitet.</p>
    </div>
    <button class="api-btn" id="apiBtn" onclick="openApiModal()">
      <span id="apiIcon">ğŸ”‘</span>
      <span id="apiLabel">API verbinden</span>
    </button>
  </header>

  <!-- STATS -->
  <div class="stats-bar" id="statsBar">
    <div class="stat"><div class="stat-n" id="statTotal">0</div><div class="stat-l">Ideen</div></div>
    <div class="stat"><div class="stat-n" id="statTopics">0</div><div class="stat-l">Themen</div></div>
    <div class="stat"><div class="stat-n" id="statCritical">0</div><div class="stat-l">Dringend</div></div>
    <div class="stat"><div class="stat-n" id="statToday">0</div><div class="stat-l">Heute</div></div>
  </div>

  <!-- INPUT CARD -->
  <div class="input-card">
    <div class="input-top">
      <select id="topicSelect" onchange="handleTopicChange()">
        <option value="">ğŸ“‚ Thema wÃ¤hlenâ€¦</option>
        <option value="ğŸ’° Geld verdienen">ğŸ’° Geld verdienen</option>
        <option value="ğŸƒ Halbmarathon">ğŸƒ Halbmarathon</option>
        <option value="ğŸ“… Tagesplanung">ğŸ“… Tagesplanung</option>
        <option value="ğŸ“– Buch schreiben">ğŸ“– Buch schreiben</option>
        <option value="__new__">â• Neues Themaâ€¦</option>
      </select>
      <input type="text" class="text-input" id="newTopicInput" placeholder="Thema eingebenâ€¦" style="display:none" onblur="confirmNewTopic()" onkeydown="if(event.key==='Enter')confirmNewTopic()">
    </div>
    <textarea id="ideaInput" placeholder="Deine Idee eingeben oder diktierenâ€¦" rows="3"></textarea>
    <div class="btn-row">
      <button class="btn btn-voice" id="voiceBtn" onclick="toggleVoice()">
        ğŸ¤ <span id="voiceLabel">Diktieren</span>
      </button>
      <button class="btn btn-gold" onclick="addIdea()">
        âœ¦ Idee speichern
      </button>
      <button class="btn btn-teal" onclick="addAndAnalyze()">
        <span id="analyzeLabel">âš¡ KI-Analyse</span>
      </button>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="section-label">Filter & Sortierung</div>
  <div class="filter-bar" id="filterBar">
    <div class="chip active" data-filter="alle" onclick="setFilter('alle')">Alle</div>
  </div>

  <div class="sort-row">
    <span class="section-label" style="margin:0">Sortieren:</span>
    <button class="sort-btn active" id="sort-neu" onclick="setSort('neu')">â†“ Neueste</button>
    <div class="sort-divider"></div>
    <button class="sort-btn" id="sort-prio" onclick="setSort('prio')">â†“ PrioritÃ¤t</button>
    <div class="sort-divider"></div>
    <button class="sort-btn" id="sort-thema" onclick="setSort('thema')">â†“ Thema</button>
  </div>

  <!-- IDEAS LIST -->
  <div id="ideasContainer"></div>
</div>

<!-- FAB BAR -->
<div class="fab-bar">
  <button class="btn btn-ghost" onclick="toggleExportMenu()">ğŸ“¤ Export</button>
  <button class="btn btn-teal" onclick="analyzeAll()">
    <span id="allAnalyzeLabel">âœ¦ Alle analysieren</span>
  </button>
</div>

<!-- EXPORT MENU -->
<div class="export-menu" id="exportMenu">
  <button class="export-item" onclick="exportPDF()">ğŸ“„ Als PDF speichern</button>
  <button class="export-item" onclick="exportText()">ğŸ“‹ Text kopieren</button>
  <button class="export-item" onclick="exportEmail()">âœ‰ï¸ Per E-Mail senden</button>
</div>

<!-- API MODAL -->
<div class="modal-overlay" id="apiModal">
  <div class="modal">
    <h2>ğŸ”‘ KI verbinden</h2>
    <p>Verbinde deinen Anthropic API-Key, um KI-Analyse, Priorisierung und Ausarbeitung zu nutzen.</p>
    <input type="password" id="apiKeyInput" placeholder="sk-ant-â€¦" autocomplete="off">
    <div class="modal-row">
      <button class="btn btn-ghost" style="flex:1" onclick="closeApiModal()">Abbrechen</button>
      <button class="btn btn-gold" style="flex:1" onclick="saveApiKey()">Verbinden</button>
    </div>
    <div style="margin-top:16px">
      <div class="section-label">Noch kein Key? So bekommst du einen:</div>
      <div class="modal-step"><strong>1. Account erstellen</strong> Besuche <a class="modal-link" href="https://console.anthropic.com" target="_blank">console.anthropic.com</a> und registriere dich gratis.</div>
      <div class="modal-step"><strong>2. API-Key erstellen</strong> Links im MenÃ¼ auf â€API Keys" â†’ â€Create Key".</div>
      <div class="modal-step"><strong>3. Billing einrichten</strong> Unter â€Billing" mindestens $5 aufladen â€“ reicht fÃ¼r viele Monate.</div>
      <div class="modal-step"><strong>4. Key hier einfÃ¼gen</strong> Kopiere den Key (beginnt mit sk-ant-â€¦) und fÃ¼ge ihn oben ein.</div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ideas = JSON.parse(localStorage.getItem('ideaflow_ideas') || '[]');
let topics = JSON.parse(localStorage.getItem('ideaflow_topics') || '["ğŸ’° Geld verdienen","ğŸƒ Halbmarathon","ğŸ“… Tagesplanung","ğŸ“– Buch schreiben"]');
let apiKey = localStorage.getItem('ideaflow_apikey') || '';
let currentFilter = 'alle';
let currentSort = 'neu';
let mediaRecognition = null;
let isRecording = false;
let exportMenuOpen = false;

const COLORS = ['#f5c842','#3fcfb4','#ff5c5c','#5b9cf6','#a78bfa','#fb923c','#34d399','#f472b6'];

function topicColor(topic) {
  const idx = topics.indexOf(topic);
  return COLORS[idx % COLORS.length] || '#888';
}

function save() {
  localStorage.setItem('ideaflow_ideas', JSON.stringify(ideas));
  localStorage.setItem('ideaflow_topics', JSON.stringify(topics));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOPIC HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleTopicChange() {
  const sel = document.getElementById('topicSelect');
  const newInput = document.getElementById('newTopicInput');
  if (sel.value === '__new__') {
    newInput.style.display = 'block';
    newInput.focus();
    sel.style.display = 'none';
  }
}

function confirmNewTopic() {
  const input = document.getElementById('newTopicInput');
  const sel = document.getElementById('topicSelect');
  const val = input.value.trim();
  if (val) {
    if (!topics.includes(val)) {
      topics.push(val);
      save();
      const opt = document.createElement('option');
      opt.value = val;
      opt.textContent = val;
      sel.insertBefore(opt, sel.querySelector('[value="__new__"]'));
    }
    sel.value = val;
  } else {
    sel.value = '';
  }
  input.style.display = 'none';
  input.value = '';
  sel.style.display = 'block';
  updateFilterChips();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOICE INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleVoice() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    showToast('Spracherkennung nicht unterstÃ¼tzt. Bitte Safari auf iPhone nutzen.', 'error');
    return;
  }
  if (isRecording) {
    stopVoice();
  } else {
    startVoice();
  }
}

function startVoice() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  mediaRecognition = new SpeechRecognition();
  mediaRecognition.lang = 'de-DE';
  mediaRecognition.continuous = true;
  mediaRecognition.interimResults = true;

  const ta = document.getElementById('ideaInput');
  const base = ta.value;
  
  mediaRecognition.onresult = (e) => {
    let interim = '';
    let final = base;
    for (let i = 0; i < e.results.length; i++) {
      if (e.results[i].isFinal) {
        final += e.results[i][0].transcript + ' ';
      } else {
        interim += e.results[i][0].transcript;
      }
    }
    ta.value = final + interim;
  };

  mediaRecognition.onerror = () => stopVoice();
  mediaRecognition.onend = () => { if (isRecording) mediaRecognition.start(); };

  mediaRecognition.start();
  isRecording = true;
  document.getElementById('voiceBtn').classList.add('recording');
  document.getElementById('voiceLabel').textContent = 'Stop';
  document.getElementById('ideaInput').classList.add('recording');
}

function stopVoice() {
  if (mediaRecognition) { mediaRecognition.onend = null; mediaRecognition.stop(); }
  isRecording = false;
  document.getElementById('voiceBtn').classList.remove('recording');
  document.getElementById('voiceLabel').textContent = 'Diktieren';
  document.getElementById('ideaInput').classList.remove('recording');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD IDEA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addIdea(analyze = false) {
  if (isRecording) stopVoice();
  const text = document.getElementById('ideaInput').value.trim();
  const topic = document.getElementById('topicSelect').value;
  if (!text) { showToast('Bitte zuerst eine Idee eingeben.', 'error'); return null; }
  if (!topic || topic === '__new__') { showToast('Bitte ein Thema auswÃ¤hlen.', 'error'); return null; }

  const idea = {
    id: Date.now(),
    text,
    topic,
    priority: 3,
    elaboration: '',
    suggestions: [],
    aiAnalyzed: false,
    createdAt: new Date().toISOString(),
    date: new Date().toLocaleDateString('de-DE')
  };

  ideas.unshift(idea);
  if (!topics.includes(topic)) { topics.push(topic); save(); }
  save();

  document.getElementById('ideaInput').value = '';
  updateFilterChips();
  render();
  updateStats();
  showToast('Idee gespeichert âœ“', 'success');
  return idea;
}

async function addAndAnalyze() {
  const idea = addIdea(true);
  if (!idea) return;
  if (!apiKey) {
    showToast('Bitte zuerst API-Key verbinden!', 'error');
    openApiModal();
    return;
  }
  setAnalyzeLabel('analyzeLabel', true);
  await analyzeIdea(idea.id);
  setAnalyzeLabel('analyzeLabel', false);
}

function setAnalyzeLabel(id, loading) {
  const el = document.getElementById(id);
  if (loading) el.innerHTML = '<span class="spinner"></span> Analysiereâ€¦';
  else el.innerHTML = 'âš¡ KI-Analyse';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI ANALYSIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function analyzeIdea(id) {
  if (!apiKey) { showToast('Kein API-Key hinterlegt.', 'error'); openApiModal(); return; }
  const idea = ideas.find(i => i.id === id);
  if (!idea) return;

  const prompt = `Du bist ein persÃ¶nlicher Strategie-Assistent. Analysiere diese Idee und antworte NUR mit validem JSON (kein Markdown, keine ErklÃ¤rungen):

Idee: "${idea.text}"
Thema: "${idea.topic}"

JSON-Format:
{
  "priority": <1-5, wobei 5=kritisch/dringend, 1=low>,
  "priorityReason": "<kurze BegrÃ¼ndung auf Deutsch>",
  "elaboration": "<ausgearbeitete Version der Idee, 2-4 SÃ¤tze auf Deutsch, konkret und umsetzbar>",
  "suggestions": ["<nÃ¤chster Schritt 1>", "<nÃ¤chster Schritt 2>", "<nÃ¤chster Schritt 3>"]
}`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 600,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    if (!res.ok) {
      const err = await res.json();
      showToast(`API-Fehler: ${err.error?.message || res.status}`, 'error');
      return;
    }

    const data = await res.json();
    const raw = data.content[0].text.trim();
    const jsonMatch = raw.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('Kein JSON gefunden');
    const result = JSON.parse(jsonMatch[0]);

    idea.priority = result.priority || 3;
    idea.elaboration = result.elaboration || '';
    idea.suggestions = result.suggestions || [];
    idea.aiAnalyzed = true;
    save();
    render();
    showToast('KI-Analyse abgeschlossen âœ“', 'success');
  } catch (e) {
    showToast('Fehler bei der KI-Analyse: ' + e.message, 'error');
  }
}

async function analyzeAll() {
  if (!apiKey) { showToast('Bitte zuerst API-Key verbinden!', 'error'); openApiModal(); return; }
  const pending = ideas.filter(i => !i.aiAnalyzed);
  if (pending.length === 0) { showToast('Alle Ideen bereits analysiert.'); return; }
  
  document.getElementById('allAnalyzeLabel').innerHTML = `<span class="spinner"></span> ${pending.length} Ideenâ€¦`;
  document.getElementById('allAnalyzeLabel').parentElement.disabled = true;

  for (const idea of pending) {
    await analyzeIdea(idea.id);
    await new Promise(r => setTimeout(r, 500));
  }

  document.getElementById('allAnalyzeLabel').innerHTML = 'âœ¦ Alle analysieren';
  document.getElementById('allAnalyzeLabel').parentElement.disabled = false;
  showToast(`${pending.length} Ideen analysiert âœ“`, 'success');
}

async function suggestNewIdeas() {
  if (!apiKey) { showToast('Bitte zuerst API-Key verbinden!', 'error'); openApiModal(); return; }
  const topicCounts = {};
  ideas.forEach(i => { topicCounts[i.topic] = (topicCounts[i.topic]||0)+1; });
  const topTopics = Object.entries(topicCounts).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([t])=>t).join(', ');
  const recentTexts = ideas.slice(0,5).map(i=>i.text).join('; ');

  const prompt = `Basierend auf diesen Themen und Ideen, generiere 3 neue, kreative Ideen die der Person noch nicht eingefallen sind. Antworte NUR mit JSON:

Themen: ${topTopics}
Bisherige Ideen (Auszug): ${recentTexts}

Format:
{"ideas":[{"topic":"<passendes Thema>","text":"<neue Idee>"},{"topic":"<>","text":"<>"},{"topic":"<>","text":"<>"}]}`;

  showToast('KI denkt nachâ€¦');
  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 400,
        messages: [{ role: 'user', content: prompt }]
      })
    });
    const data = await res.json();
    const raw = data.content[0].text.trim();
    const jsonMatch = raw.match(/\{[\s\S]*\}/);
    const result = JSON.parse(jsonMatch[0]);
    result.ideas.forEach(ni => {
      const topic = ni.topic && topics.includes(ni.topic) ? ni.topic : (topics[0] || '');
      ideas.unshift({ id: Date.now() + Math.random(), text: 'ğŸ’¡ ' + ni.text, topic, priority: 3, elaboration: '', suggestions: [], aiAnalyzed: false, createdAt: new Date().toISOString(), date: new Date().toLocaleDateString('de-DE'), aiSuggested: true });
    });
    save();
    render();
    updateStats();
    showToast('3 neue Ideen vorgeschlagen âœ“', 'success');
  } catch(e) {
    showToast('Fehler: ' + e.message, 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DELETE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function deleteIdea(id) {
  ideas = ideas.filter(i => i.id !== id);
  save();
  render();
  updateStats();
  showToast('Idee gelÃ¶scht');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTERS & SORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setFilter(f) {
  currentFilter = f;
  document.querySelectorAll('.chip').forEach(c => c.classList.toggle('active', c.dataset.filter === f));
  render();
}

function setSort(s) {
  currentSort = s;
  document.querySelectorAll('.sort-btn').forEach(b => b.classList.toggle('active', b.id === 'sort-' + s));
  render();
}

function updateFilterChips() {
  const bar = document.getElementById('filterBar');
  bar.innerHTML = '<div class="chip active" data-filter="alle" onclick="setFilter(\'alle\')">Alle</div>';
  topics.forEach(t => {
    const c = document.createElement('div');
    c.className = 'chip' + (currentFilter === t ? ' active' : '');
    c.dataset.filter = t;
    c.onclick = () => setFilter(t);
    c.textContent = t;
    bar.appendChild(c);
  });
  // reapply active
  document.querySelectorAll('.chip').forEach(c => c.classList.toggle('active', c.dataset.filter === currentFilter));
}

function getFilteredSorted() {
  let list = currentFilter === 'alle' ? [...ideas] : ideas.filter(i => i.topic === currentFilter);
  if (currentSort === 'neu') list.sort((a,b) => b.id - a.id);
  else if (currentSort === 'prio') list.sort((a,b) => b.priority - a.priority);
  else if (currentSort === 'thema') list.sort((a,b) => a.topic.localeCompare(b.topic));
  return list;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function priorityLabel(p) {
  const labels = ['', 'Niedrig', 'Normal', 'Mittel', 'Hoch', 'Kritisch'];
  const icons = ['', 'â—‹', 'â—‡', 'â—†', 'â–²', 'âš¡'];
  return { label: labels[p] || 'Normal', icon: icons[p] || 'â—‡' };
}

function render() {
  const container = document.getElementById('ideasContainer');
  const list = getFilteredSorted();

  if (list.length === 0) {
    container.innerHTML = `
      <div class="empty">
        <div class="empty-icon">ğŸ’¡</div>
        <h3>Noch keine Ideen</h3>
        <p>Gib oben deine erste Idee ein oder diktiere sie direkt.<br>Die KI hilft dir bei Priorisierung und Ausarbeitung.</p>
      </div>`;
    return;
  }

  if (currentSort === 'thema') {
    // Group by topic
    const groups = {};
    list.forEach(i => { if (!groups[i.topic]) groups[i.topic] = []; groups[i.topic].push(i); });
    container.innerHTML = '';
    Object.entries(groups).forEach(([topic, tIdeas]) => {
      const g = document.createElement('div');
      g.className = 'topic-group';
      g.innerHTML = `
        <div class="group-header" onclick="toggleGroup('g_${topic.replace(/\s/g,'')}')">
          <div class="group-dot" style="background:${topicColor(topic)}"></div>
          <div class="group-name">${topic}</div>
          <div class="group-count">${tIdeas.length}</div>
          <div class="group-chevron" id="chev_g_${topic.replace(/\s/g,'')}">â–¼</div>
        </div>
        <div class="ideas-list" id="g_${topic.replace(/\s/g,'')}">
          ${tIdeas.map(i => cardHTML(i)).join('')}
        </div>`;
      container.appendChild(g);
    });
  } else {
    container.innerHTML = `<div class="ideas-list">${list.map(i => cardHTML(i)).join('')}</div>`;
  }
}

function cardHTML(idea) {
  const pInfo = priorityLabel(idea.priority);
  const color = topicColor(idea.topic);
  const hasMeta = idea.aiAnalyzed;
  return `
  <div class="idea-card" id="card_${idea.id}">
    <div class="pbar" style="background:${color}"></div>
    <div class="card-top">
      <div class="idea-body">
        <div class="idea-text">${escHtml(idea.text)}${idea.aiSuggested ? ' <span style="font-size:11px;color:var(--text3)">KI-Vorschlag</span>' : ''}</div>
        ${idea.elaboration ? `<div class="idea-elaboration visible">${escHtml(idea.elaboration)}</div>` : ''}
        ${idea.suggestions && idea.suggestions.length ? `
          <div class="idea-suggestions visible">
            <span style="font-size:11px;color:var(--purple);font-weight:600;text-transform:uppercase;letter-spacing:0.5px">NÃ¤chste Schritte</span>
            <ul>${idea.suggestions.map(s=>`<li>${escHtml(s)}</li>`).join('')}</ul>
          </div>` : ''}
      </div>
      <div class="pbadge p${idea.priority}">${pInfo.icon} ${pInfo.label}</div>
    </div>
    <div class="card-meta">
      <span class="meta-tag" style="color:${color}">â— ${idea.topic}</span>
      <span class="meta-tag">ğŸ—“ ${idea.date}</span>
      ${idea.aiAnalyzed ? '<span class="meta-tag" style="color:var(--teal)">âš¡ KI</span>' : ''}
      <div class="card-actions">
        ${!idea.aiAnalyzed ? `<button class="btn btn-ghost btn-sm" onclick="analyzeIdeaBtn(${idea.id})">âš¡ Analysieren</button>` : ''}
        <button class="btn btn-icon btn-sm" onclick="deleteIdea(${idea.id})" title="LÃ¶schen">âœ•</button>
      </div>
    </div>
  </div>`;
}

async function analyzeIdeaBtn(id) {
  if (!apiKey) { showToast('Bitte zuerst API-Key verbinden!', 'error'); openApiModal(); return; }
  const card = document.getElementById('card_' + id);
  const btn = card.querySelector('.btn-ghost');
  if (btn) { btn.innerHTML = '<span class="spinner"></span>'; btn.disabled = true; }
  await analyzeIdea(id);
}

function toggleGroup(id) {
  const el = document.getElementById(id);
  const chev = document.getElementById('chev_' + id);
  const closed = el.style.display === 'none';
  el.style.display = closed ? 'flex' : 'none';
  if (chev) chev.classList.toggle('closed', !closed);
}

function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/\n/g,'<br>');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStats() {
  document.getElementById('statTotal').textContent = ideas.length;
  document.getElementById('statTopics').textContent = topics.length;
  document.getElementById('statCritical').textContent = ideas.filter(i => i.priority >= 4).length;
  const today = new Date().toLocaleDateString('de-DE');
  document.getElementById('statToday').textContent = ideas.filter(i => i.date === today).length;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openApiModal() {
  document.getElementById('apiModal').classList.add('open');
  if (apiKey) document.getElementById('apiKeyInput').value = apiKey;
}
function closeApiModal() {
  document.getElementById('apiModal').classList.remove('open');
}
function saveApiKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (!key.startsWith('sk-ant-')) {
    showToast('UngÃ¼ltiger Key â€“ muss mit sk-ant- beginnen', 'error');
    return;
  }
  apiKey = key;
  localStorage.setItem('ideaflow_apikey', apiKey);
  closeApiModal();
  updateApiBtn();
  showToast('API verbunden âœ“', 'success');
}
function updateApiBtn() {
  const btn = document.getElementById('apiBtn');
  const icon = document.getElementById('apiIcon');
  const label = document.getElementById('apiLabel');
  if (apiKey) {
    btn.classList.add('connected');
    icon.textContent = 'âœ“';
    label.textContent = 'KI aktiv';
  } else {
    btn.classList.remove('connected');
    icon.textContent = 'ğŸ”‘';
    label.textContent = 'API verbinden';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleExportMenu() {
  exportMenuOpen = !exportMenuOpen;
  document.getElementById('exportMenu').classList.toggle('open', exportMenuOpen);
}

document.addEventListener('click', (e) => {
  if (!e.target.closest('.export-menu') && !e.target.closest('.fab-bar')) {
    exportMenuOpen = false;
    document.getElementById('exportMenu').classList.remove('open');
  }
});

function exportText() {
  const lines = ['# IDEAFLOW â€“ Alle Ideen\n', `Exportiert: ${new Date().toLocaleString('de-DE')}\n`];
  topics.forEach(t => {
    const tIdeas = ideas.filter(i => i.topic === t);
    if (!tIdeas.length) return;
    lines.push(`\n## ${t}\n`);
    tIdeas.sort((a,b) => b.priority - a.priority).forEach(idea => {
      const pInfo = priorityLabel(idea.priority);
      lines.push(`[${pInfo.icon} ${pInfo.label}] ${idea.text}`);
      if (idea.elaboration) lines.push(`  â†’ ${idea.elaboration}`);
      if (idea.suggestions?.length) idea.suggestions.forEach(s => lines.push(`  â€¢ ${s}`));
      lines.push('');
    });
  });
  navigator.clipboard.writeText(lines.join('\n')).then(() => showToast('Text kopiert âœ“', 'success'));
  toggleExportMenu();
}

function exportEmail() {
  const lines = ['IDEAFLOW â€“ Meine Ideen\n'];
  topics.forEach(t => {
    const tIdeas = ideas.filter(i => i.topic === t);
    if (!tIdeas.length) return;
    lines.push(`\n${t.toUpperCase()}`);
    tIdeas.forEach(idea => lines.push(`â€¢ ${idea.text}`));
  });
  const body = encodeURIComponent(lines.join('\n'));
  window.location.href = `mailto:?subject=Meine IdeaFlow-Ideen&body=${body}`;
  toggleExportMenu();
}

function exportPDF() {
  window.print();
  toggleExportMenu();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTimeout;
function showToast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (type ? ' ' + type : '');
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => t.classList.remove('show'), 2800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  // sync topics to select
  const sel = document.getElementById('topicSelect');
  const existingOpts = [...sel.options].map(o => o.value);
  topics.forEach(t => {
    if (!existingOpts.includes(t)) {
      const opt = document.createElement('option');
      opt.value = t; opt.textContent = t;
      sel.insertBefore(opt, sel.querySelector('[value="__new__"]'));
    }
  });

  updateFilterChips();
  render();
  updateStats();
  updateApiBtn();

  // Close modal on overlay click
  document.getElementById('apiModal').addEventListener('click', function(e) {
    if (e.target === this) closeApiModal();
  });
}

init();
</script>

<!-- Print styles -->
<style>
@media print {
  .fab-bar, .input-card, .filter-bar, .sort-row, header .api-btn, .export-menu, .toast { display: none !important; }
  body { background: white; color: black; }
  .idea-card { background: white; border: 1px solid #ddd; break-inside: avoid; }
  .pbar { display: none; }
  .group-name { color: #333; }
  .idea-text { color: #111; }
}
</style>
</body>
</html>
